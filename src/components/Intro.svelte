<script>
    import Year from "./Year.svelte";
    import Content from "./content/Content.svelte";
    import Flyout from "./flyout/Flyout.svelte";
    
    import translations from "$trad"; 
	import ContentPanel from "../routes/_components/ContentPanel.svelte";
	import Qrteste from "../routes/_components/qrteste.svelte";
	import ContentArea from "../routes/_components/ContentArea.svelte";
	import ContentTitle from "../routes/_components/ContentTitle.svelte";
	import GeneralField from "../routes/_components/GeneralField.svelte";
	import ContentQr from "../routes/_components/ContentQR.svelte";
	import ContentText from "../routes/_components/ContentText.svelte";
	import QrText from "../routes/_components/QrText.svelte";
	import ContentButton from "../routes/_components/ContentButton.svelte";
	import PixSvg from "../routes/_components/PIX_SVG.svelte";
	import ContentBanner from "../routes/_components/ContentBanner.svelte";
	import ContentValue from "../routes/_components/ContentValue.svelte";
	import IconField from "../routes/_components/IconField.svelte";
	import { goto } from "$app/navigation";
	import { page } from "$app/stores";
	import { onMount } from "svelte";
	import buildPixPayload from "$lib/buildPix";
	import DarkModeSwitch from "./DarkModeSwitch.svelte";

    let texts; 
    translations.subscribe(value => {
        texts = value;
    });

	$: method = $page.params.method;

    export let data;
    const {slugs, paymentData} = data;
    let searchParams = {};


    let list =  Object.entries(paymentData).map(e => {
        let item = e[1];
        item.key = e[0];

        return item;
    });

    let pixQR = "";
	$: selected = method && paymentData ? paymentData[method] : null;
    $: if(selected != undefined) {
        if(selected.type == "pix") {
            const obj = {
                ...selected.pixData,
                value: isNaN(slugs.value)? null: slugs.value,
                message: searchParams.message,
                // message comes from hash
            }
            pixQR = buildPixPayload(obj);
        }
    }


    const gotoObj = (obj, getPath = false) => {
        let path = `/${paymentData[obj.method] !== undefined ? obj.method : "_"}`; 
        if (obj.value) path += `/${obj.value}`;

        let urlParams = "";
        
        if (typeof window !== 'undefined') {
            let search = window.location.search || '';
            let hash = window.location.hash || '';

            urlParams += search + hash;
        }
        path += urlParams;

        if (getPath) return path;

        goto(path);
    };

    let qrCodeGenerated = "";
    const copyCode = () => {
        console.log("not yet implemented")
    }

    onMount(()=>{
        const params = new URLSearchParams(location.search);
        searchParams = Object.fromEntries(params.entries());
        console.log(searchParams);

        console.log(dmSwitch)

        document.querySelectorAll(".doHash").forEach(e=>e.href=gotoObj({...slugs, method: e.dataset.key}, true));
    });

    let dmSwitch;
</script>

<div class="wrapper">
    <div class="flyout">
        <Flyout />
    </div>
    <div class="right">
        <div class="contentHeader">
            <div class="year">
                <Year> <span class="hidden">{texts.curriculum.toUpperCase()}</span> 2025 </Year>
            </div>
            <h1 class="title">Luís Henrique de Almeida</h1>
        </div>
        <div class="content">
            <ContentPanel>
            {#if selected != undefined}
                {#if selected.type == "pix"}
                    
                    <div class="contentArea">
                        <ContentArea>
                            <ContentTitle>código qr</ContentTitle>
                            <GeneralField>
                                <ContentQr code={pixQR} />
                            </GeneralField>
                            <div class="inlineField">
                                <GeneralField>
                                    <ContentText> 
                                        <QrText selection="all"> {pixQR} </QrText>
                                    </ContentText>
                                </GeneralField>

                                <ContentButton action={copyCode}>
                                    Copiar ©
                                </ContentButton>
                            </div>
                            <div class="inlineField">
                                <ContentButton type="fit-container">
                                    Ir ao app do Banco ➽
                                </ContentButton>
                            </div>
                        </ContentArea>
                    </div>
                {/if}

                <div class="contentArea">
                    {#if selected.type == "pix"}
                        <ContentBanner>
                            <PixSvg />
                        </ContentBanner> 
                    {/if}                     
                    <ContentArea>
                        <ContentTitle>Informações</ContentTitle>
                        
                        {#if !isNaN(slugs.value)}  
                        <ContentValue name="Valor" value={slugs.value}/>
                        {/if}

                        <IconField icon={selected.icon} bg={selected.bg} selection="all">
                            {selected.name}
                        </IconField>

                        <IconField icon={selected.owner.icon} bg={selected.owner.bg} selection="all">
                            {selected.owner.name}
                        </IconField>

                        <IconField icon={`/assets/payments/${selected.owner.type}.png`} selection="all">
                            {selected.owner.code}
                        </IconField>
                    </ContentArea>
                </div>
                <div class="contentArea">
                    <ContentArea>
                        <ContentTitle> Mais </ContentTitle>
                        {#if searchParams.lm == "1"}
                            <div class="inlineField">
                                <GeneralField style="width: 100%;">
                                    <ContentText style="text-align: left; width: 100%;"> Outras formas de pagamento </ContentText>
                                </GeneralField>

                                <a class="doHash buttonContainer" data-key="_" on:click|preventDefault={() => gotoObj({...slugs, method: method.key})} href>
                                    <ContentButton>
                                        ➽
                                    </ContentButton>
                                </a>
                            </div>
                        {/if}
                        <div class="inlineField">
                            <GeneralField style="width: 100%;">
                                <ContentText style="text-align: left; width: 100%;">
                                    Mudar modo de cor
                                </ContentText>
                            </GeneralField>


                            <div class="buttonContainer">
                                <ContentButton action={dmSwitch?.switchState}>
                                    ☀
                                </ContentButton>
                            </div>
                            <div class="dmSwitch" style="display:none">
				                <DarkModeSwitch bind:this={dmSwitch} style="transform: scale(0.6); margin: -15px -27px -20px -27px; filter: none;" />
                            </div>
                        </div>
                    </ContentArea>

                    <ContentArea>
                        <div class="inlineField">
                            <GeneralField style="width: 100%;">
                                <ContentText style="text-align: left; width: 100%;">
                                    Compartilhar este link
                                </ContentText>
                            </GeneralField>


                            <div class="buttonContainer">
                                <ContentButton type="fit-container">
                                    ?
                                </ContentButton>
                            </div>
                        </div>
                        <div class="inlineField">
                            <GeneralField style="width: 100%;">
                                <ContentText style="text-align: left; width: 100%;">
                                    Compartilhar o site
                                </ContentText>
                            </GeneralField>


                            <div class="buttonContainer">
                                <ContentButton type="fit-container">
                                    ?
                                </ContentButton>
                            </div>
                        </div>
                    </ContentArea>
                </div>
                <!--
                
                <Qrteste></Qrteste>
                deve ter texto explicativo, nome do banco, imagem do banco, (opcional) mostrar o valor
                
                pegar banco dos parametros, nu se não tiver parametro
                
                encaixar o DarkModeSwitch dentro do ContentPanel
                
                mudar titulo da pagina
                
                transformar imagem em svg e estilizar
                
                enviar email com emailjs
                -->
            {:else}
                <div class="contentArea">
                    <ContentArea>
                        <ContentTitle> Selecione </ContentTitle>
                        <ContentTitle type="sub"> [svg br & color] - Brasil </ContentTitle>
                        <ContentTitle type="mini"> [svg pix] - PIX </ContentTitle>
                        
                        {#each list as method}
                            <a class="listItem doHash" data-key={method.key} on:click|preventDefault={() => gotoObj({...slugs, method: method.key})} href>    
                                <IconField icon={method.icon} bg={method.bg}>
                                    {method.type.toUpperCase()} - {method.name}
                                </IconField>
                            </a>
                        {/each}
                    </ContentArea>
                </div>
            {/if}
            </ContentPanel>
        </div>
    </div>
</div>

<style lang="scss">
    @use "$style/_fonts.scss";
    @use "$style/_defaults" as defaults;
    @use "$style/_palette.scss" as palette;

    .doHash {
        text-decoration: none;

        &:visited {
            color: inherit; 
        }
    }
    .inlineField .buttonContainer {
        width: 70px;
        display: flex;
        justify-content: stretch;
    }

    .content {
        display: flex;
        flex-direction: row;
        justify-content: center;

        .listItem {
            width: 100%;
            
        }

        .contentArea {
            max-width: 400px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;

            .inlineField {
                width: 100%;
                display: flex;
                flex-direction: row;
                justify-content: center;
                gap: 5px;
            }
        }
    }


    .contentHeader {
            -bottom: 50px;
        display: flex;
        align-items: center;
        justify-content: space-between;

        .title {
            user-select: none;
            font-family: robotoMono;
            text-transform: uppercase;
            color: palette.$highlight;
            text-shadow: -4px 4px 4px rgba(0, 0, 0, 0.25);
        }

        .year {
            margin-left: 20px;

            .hidden {
                display: none;
            }
        }
    }

    .wrapper {
        display: flex;
        justify-content: center;
        font-size: 30px;
        text-align: right;
        padding: 25px;
        padding-top: 0;

        max-width: 1940px;

        .right {
            width: 100%;
            max-width: 1300px;
        }
    }

    

    @media only screen and (max-width: defaults.$mediaMaxWidth) { 
        .contentHeader {
            flex-direction: column;
            margin-bottom: 50px;

            .title  {
                display: none;
            }

            .year {
                width: 100%;
                margin-left: 0;

                .hidden {
                    display: inline;
                }
            }
        }
        .wrapper {
            padding: 0;
            flex-direction: column;
            align-items: center;

            .flyout {
                margin-bottom: 10px;
            }
        }
    }
</style>